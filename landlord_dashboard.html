<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X-Homes | Tenant Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1, h2 { color: #333; }
    .search-bar { margin-bottom: 20px; }
    .card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .property-images img { width: 100px; height: 80px; margin-right: 5px; border-radius: 5px; }
    .proximities span { background: #eee; padding: 3px 8px; margin-right: 5px; border-radius: 5px; font-size: 12px; }
    .actions button { margin-right: 10px; }
    .responses { margin-top: 10px; background: #f1f1f1; padding: 10px; border-radius: 8px; }
    .response { margin-bottom: 5px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Tenant Dashboard</h1>

  <!-- Search Bar -->
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search by location (e.g. Kumasi, Accra)" style="width:70%; padding:8px;">
    <button onclick="searchProperties()">Search</button>
  </div>

  <!-- Property Listings -->
  <div id="propertyList"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, doc, getDoc, query, where, orderBy, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentTenantId = null;
    let properties = [];

    // Auth check
    onAuthStateChanged(auth, user => {
      if (user) {
        currentTenantId = user.uid;
        loadProperties();
      } else {
        window.location.href = "login.html";
      }
    });

    // Load properties
    async function loadProperties() {
      const querySnapshot = await getDocs(collection(db, "properties"));
      properties = [];
      querySnapshot.forEach(docSnap => {
        properties.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderProperties(properties);
    }

    // Search
    window.searchProperties = () => {
      const term = document.getElementById("searchInput").value.toLowerCase();
      const filtered = properties.filter(p => p.location.toLowerCase().includes(term));
      renderProperties(filtered);
    };

    // Render
    async function renderProperties(list) {
      const container = document.getElementById("propertyList");
      container.innerHTML = "";

      for (let p of list) {
        let responsesHTML = "";
        const notifQuery = query(collection(db, "notifications"), where("tenantId", "==", currentTenantId), where("propertyId", "==", p.id));
        const notifSnap = await getDocs(notifQuery);
        notifSnap.forEach(async notifDoc => {
          const responsesRef = collection(db, "notifications", notifDoc.id, "responses");
          const responseSnap = await getDocs(responsesRef);
          responseSnap.forEach(r => {
            const res = r.data();
            responsesHTML += `<div class="response"><strong>${res.mode}:</strong> ${res.message}</div>`;
          });
        });

        container.innerHTML += `
          <div class="card">
            <h3>${p.title}</h3>
            <p><strong>Location:</strong> ${p.location}</p>
            <p><strong>Price:</strong> GHS ${p.price}/month</p>
            <div class="property-images">
              ${p.images?.map(img => `<img src="${img}" alt="Property">`).join("") || ""}
            </div>
            <div class="proximities">
              ${p.proximities?.map(pr => `<span>${pr}</span>`).join("") || ""}
            </div>
            <p><strong>Agreement:</strong> ${p.agreement || "No agreement uploaded"}</p>
            <div class="actions">
              <button onclick="notifyLandlord('${p.id}','${p.title}','${p.landlordId}')">Notify Landlord</button>
              <button onclick="bookProperty('${p.id}')">Book Now</button>
            </div>
            <div class="responses">${responsesHTML || "<i>No responses yet</i>"}</div>
          </div>
        `;
      }
    }

    // Notify landlord
    window.notifyLandlord = async (propertyId, propertyTitle, landlordId) => {
      const tenant = auth.currentUser;
      await addDoc(collection(db, "notifications"), {
        landlordId,
        tenantId: tenant.uid,
        tenantName: tenant.displayName || "Anonymous",
        tenantEmail: tenant.email || "",
        tenantPhone: tenant.phoneNumber || "",
        propertyId,
        propertyTitle,
        status: "pending",
        timestamp: serverTimestamp()
      });
      alert("Notification sent to landlord!");
    };

    // Book property (placeholder for now)
    window.bookProperty = (propertyId) => {
      alert(`Booking flow for property ${propertyId} will be implemented next.`);
    };
  </script>
</body>
</html>
