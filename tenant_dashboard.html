<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>X-HOMES | Tenant Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6fb;
    }
    header {
      background: darkred;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 10px;
    }
    .search-bar {
      text-align: center;
      margin-bottom: 20px;
    }
    .search-bar input {
      padding: 10px;
      width: 60%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .search-bar button {
      padding: 10px 16px;
      background: navy;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .search-bar button:hover {
      background: darkred;
    }
    .properties {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .property-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .property-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .property-card button {
      background: navy;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px 5px 0 0;
    }
    .property-card button:hover {
      background: darkred;
    }
    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      margin: 20px 0;
    }
    /* Agreement Modal */
    #agreementModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 70%;
      max-width: 800px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #agreementModal h2 {
      margin-top: 0;
    }
    #agreementContent {
      margin: 15px 0;
      line-height: 1.5;
    }
    #agreementModal button {
      margin: 5px;
    }
  </style>
</head>
<body>
  <header>Tenant Dashboard</header>
  <div class="container">
    <!-- Search -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by location (e.g., Kumasi, Accra)">
      <button onclick="searchProperties()">Search</button>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Property Listings -->
    <div class="properties" id="propertiesList"></div>
  </div>

  <!-- Agreement Modal -->
  <div id="agreementModal">
    <h2>Tenancy Agreement</h2>
    <div id="agreementContent"></div>
    <button onclick="approveAgreement()">✅ Approve</button>
    <button onclick="rejectAgreement()">❌ Reject</button>
    <button onclick="closeAgreementModal()">Close</button>
  </div>

  <!-- Firebase + Google Maps + jsPDF -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let map, markers = [];
    let selectedPropertyId = null;
    let selectedAgreementData = null;

    // Initialize Google Map
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 7.9465, lng: -1.0232 }, // Ghana center
        zoom: 7,
      });
    }
    window.onload = initMap;

    // Load properties from Firestore
    async function loadProperties() {
      const snapshot = await db.collection("properties").get();
      const propertiesList = document.getElementById("propertiesList");
      propertiesList.innerHTML = "";
      markers.forEach(m => m.setMap(null));
      markers = [];

      snapshot.forEach(doc => {
        const p = doc.data();
        const div = document.createElement("div");
        div.className = "property-card";
        div.innerHTML = `
          <img src="${p.images ? p.images[0] : 'https://via.placeholder.com/300'}" alt="Property">
          <h3>${p.title}</h3>
          <p><strong>Location:</strong> ${p.location}</p>
          <p><strong>Price:</strong> GHS ${p.price}/month</p>
          <button onclick="viewAgreement('${doc.id}')">View Agreement</button>
          <button onclick="notifyLandlord('${doc.id}', '${p.ownerId}')">Notify Landlord</button>
          <button onclick="bookNow('${doc.id}')">Book Now</button>
        `;
        propertiesList.appendChild(div);

        // Add marker to map
        if (p.lat && p.lng) {
          const marker = new google.maps.Marker({
            position: { lat: p.lat, lng: p.lng },
            map: map,
            title: p.title,
          });
          markers.push(marker);
        }
      });
    }

    // Search properties by location
    function searchProperties() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const cards = document.querySelectorAll(".property-card");
      cards.forEach(card => {
        const location = card.querySelector("p").innerText.toLowerCase();
        card.style.display = location.includes(query) ? "block" : "none";
      });
    }

    // Agreement functions
    async function viewAgreement(propertyId) {
      selectedPropertyId = propertyId;

      try {
        const docSnap = await db.collection("properties").doc(propertyId).get();
        if (docSnap.exists) {
          const data = docSnap.data();
          selectedAgreementData = data;

          document.getElementById("agreementContent").innerHTML = `
            <p><strong>Rules & Regulations:</strong></p>
            <p>${data.rules || "Not provided"}</p>
            <p><strong>Tenancy Agreement Terms:</strong></p>
            <p>${data.agreement || "Not provided"}</p>
          `;

          document.getElementById("agreementModal").style.display = "block";
        } else {
          alert("No agreement found for this property.");
        }
      } catch (error) {
        alert("Error fetching agreement: " + error.message);
      }
    }

    function closeAgreementModal() {
      document.getElementById("agreementModal").style.display = "none";
    }

    async function rejectAgreement() {
      if (!selectedPropertyId || !auth.currentUser) return;

      try {
        await db.collection("properties").doc(selectedPropertyId).update({
          [`agreements.${auth.currentUser.uid}`]: {
            status: "rejected",
            timestamp: new Date().toISOString(),
            tenantName: auth.currentUser.displayName || auth.currentUser.email
          }
        });

        alert("You have rejected the agreement. Decision stored.");
        closeAgreementModal();
      } catch (error) {
        alert("Error saving rejection: " + error.message);
      }
    }

    async function approveAgreement() {
      if (!selectedAgreementData || !selectedPropertyId || !auth.currentUser) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(14);
      doc.text("X-HOMES Official Tenancy Agreement", 10, 20);

      doc.setFontSize(12);
      doc.text(`Tenant Name: ${auth.currentUser.displayName || auth.currentUser.email}`, 10, 40);
      doc.text(`Landlord Code: ${selectedAgreementData.ownerCode || "N/A"}`, 10, 50);
      doc.text(`Property: ${selectedAgreementData.title || "N/A"}`, 10, 60);
      doc.text(`Location: ${selectedAgreementData.location || "N/A"}`, 10, 70);
      doc.text(`Rent: GHS ${selectedAgreementData.price}/month`, 10, 80);

      doc.text("Rules & Regulations:", 10, 100);
      doc.text(selectedAgreementData.rules || "Not provided", 10, 110, { maxWidth: 180 });

      doc.text("Tenancy Terms:", 10, 140);
      doc.text(selectedAgreementData.agreement || "Not provided", 10, 150, { maxWidth: 180 });

      doc.text("Agreement Status: APPROVED ✅", 10, 200);

      doc.save("Tenancy_Agreement.pdf");

      try {
        await db.collection("properties").doc(selectedPropertyId).update({
          [`agreements.${auth.currentUser.uid}`]: {
            status: "approved",
            timestamp: new Date().toISOString(),
            tenantName: auth.currentUser.displayName || auth.currentUser.email
          }
        });

        alert("Agreement approved ✅ and decision stored.");
        closeAgreementModal();
      } catch (error) {
        alert("Error saving approval: " + error.message);
      }
    }

    // Placeholder functions
    function notifyLandlord(propertyId, ownerId) {
      alert("Notify Landlord feature coming soon!");
    }
    function bookNow(propertyId) {
      alert("Book Now feature coming soon!");
    }

    // Load properties after login
    auth.onAuthStateChanged(user => {
      if (user) {
        loadProperties();
      } else {
        window.location.href = "login.html";
      }
    });
  </script>
</body>
</html>
